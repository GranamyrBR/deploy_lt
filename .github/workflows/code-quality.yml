name: Code Quality

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  code-metrics:
    name: MÃ©tricas de CÃ³digo
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ¯ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: 'stable'
        channel: 'stable'
        cache: true

    - name: ğŸ“¦ Instalar dependÃªncias
      run: flutter pub get

    - name: ğŸ“Š AnÃ¡lise de complexidade
      run: |
        echo "## ğŸ“Š MÃ©tricas de CÃ³digo" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### EstatÃ­sticas:" >> $GITHUB_STEP_SUMMARY
        echo "- Total de arquivos Dart: $(find lib -name '*.dart' | wc -l)" >> $GITHUB_STEP_SUMMARY
        echo "- Linhas de cÃ³digo: $(find lib -name '*.dart' -exec cat {} \; | wc -l)" >> $GITHUB_STEP_SUMMARY
        echo "- Total de testes: $(find test -name '*_test.dart' | wc -l)" >> $GITHUB_STEP_SUMMARY

    - name: ğŸ” Verificar TODOs
      run: |
        echo "### ğŸ“ TODOs encontrados:" >> $GITHUB_STEP_SUMMARY
        grep -r "TODO" lib/ || echo "Nenhum TODO encontrado!" >> $GITHUB_STEP_SUMMARY
      continue-on-error: true

    - name: ğŸ” AnÃ¡lise estÃ¡tica detalhada
      run: flutter analyze --write=analyze-report.txt
      continue-on-error: true

    - name: ğŸ“¤ Upload relatÃ³rio
      uses: actions/upload-artifact@v3
      with:
        name: analysis-report
        path: analyze-report.txt
      continue-on-error: true

  security-scan:
    name: Scan de SeguranÃ§a
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ”’ Verificar secrets expostos
      run: |
        echo "Verificando secrets expostos..."
        # Verificar se hÃ¡ chaves ou tokens hardcoded
        if grep -r "sk_live_" lib/ 2>/dev/null; then
          echo "âš ï¸ PossÃ­vel secret encontrado!"
          exit 1
        fi
        echo "âœ… Nenhum secret exposto encontrado"
      continue-on-error: true

    - name: ğŸ” Verificar .env na raiz
      run: |
        if [ -f ".env" ]; then
          echo "âš ï¸ Arquivo .env encontrado na raiz (nÃ£o deveria estar no Git)"
          exit 1
        fi
        echo "âœ… Nenhum .env no repositÃ³rio"
