name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Job 1: AnÃ¡lise e Testes
  test:
    name: AnÃ¡lise e Testes
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: â˜• Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: ğŸ¯ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.16.0'
        channel: 'stable'
        cache: true

    - name: ğŸ“¦ Instalar dependÃªncias
      run: flutter pub get

    - name: ğŸ” Verificar formataÃ§Ã£o
      run: dart format --set-exit-if-changed .
      continue-on-error: true

    - name: ğŸ” AnÃ¡lise estÃ¡tica
      run: flutter analyze

    - name: ğŸ§ª Executar testes
      run: flutter test --coverage

    - name: ğŸ“Š Upload de cobertura
      uses: codecov/codecov-action@v3
      with:
        files: coverage/lcov.info
        fail_ci_if_error: false
      continue-on-error: true

  # Job 2: Build Web
  build-web:
    name: Build Web
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ¯ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.16.0'
        channel: 'stable'
        cache: true

    - name: ğŸ“¦ Instalar dependÃªncias
      run: flutter pub get

    - name: ğŸ—ï¸ Build Web
      run: flutter build web --release --web-renderer html

    - name: ğŸ“¤ Upload artefatos
      uses: actions/upload-artifact@v3
      with:
        name: web-build
        path: build/web/
        retention-days: 7

  # Job 3: Deploy Firebase (opcional)
  deploy-firebase:
    name: Deploy para Firebase
    needs: build-web
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ¯ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.16.0'
        channel: 'stable'
        cache: true

    - name: ğŸ“¦ Instalar dependÃªncias
      run: flutter pub get

    - name: ğŸ—ï¸ Build Web
      run: flutter build web --release --web-renderer html

    - name: ğŸ”¥ Deploy para Firebase Hosting
      uses: FirebaseExtended/action-hosting-deploy@v0
      with:
        repoToken: '${{ secrets.GITHUB_TOKEN }}'
        firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}'
        channelId: live
        projectId: lecotour-dashboard
      continue-on-error: true

  # Job 4: NotificaÃ§Ãµes
  notify:
    name: NotificaÃ§Ãµes
    needs: [test, build-web]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ğŸ“¢ Status do Pipeline
      run: |
        echo "âœ… Pipeline executado!"
        echo "Status do teste: ${{ needs.test.result }}"
        echo "Status do build: ${{ needs.build-web.result }}"
